/*!
 * LocalModel
 * Developer: Rick Craig
 * https://github.com/RickCraig/localmodel
*/
!function(t){"use strict";function e(t,e){for(var n={},r=Object.keys(t),i=Object.keys(e),o=0;o<r.length;o++)n[r[o]]=t[r[o]];for(var s=0;s<i.length;s++)n[i[s]]=e[i[s]];return n}var n=function(t){for(var e in t)if(t.hasOwnProperty(e))return!1;return!0},r=function(t){for(var e=0;e<t.length;e++)if(!t[e])return!0;return!1},i=function(t){return t instanceof Object||t instanceof Array?!0:!1},o=function(t,e){return t.map(function(t){for(var n={},r=0;r<e.length;r++)n[e[r]]=t[e[r]];return n})},s=function(t,e,n){for(var r=t.length,i=0;r>i;i++)if(t[i][e]===n)return i;return-1},a=function(){var t=Date.now(),e="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var n=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"===e?n:3&n|8).toString(16)});return e},h=function(t,e){return t+"::"+e},u=function(t,e,n){var r=t+"-index",i=n.storage.getItem(r),o=i?JSON.parse(i):[];o.push(e),n.storage.setItem(r,JSON.stringify(o))},c=function(t,e){var n=e.storage.getItem(t+"-index");return JSON.parse(n)},p=function(t,e){for(var n=new RegExp("::"+e,"g"),r=0;r<t.length;r++){var i=t[r];if(n.test(i))return i}},f=function(t,e,n){var r=c(t,n),i=r.indexOf(e);i>-1?(r.splice(i,1),n.storage.setItem(t+"-index",JSON.stringify(r))):console.error(new Error('The key "'+e+"\" doesn't exist"))},l=function(){};l.prototype.match=function(t,e,i){return n(e.$match)?t:t.filter(function(t){var n=i.checkEntry(t,e.$match);return n.length>0&&!r(n)?!0:!1})},l.prototype.createGroup=function(t,e){var n=e.$group,r=[],i=this;if("undefined"==typeof n._id)return console.error("the $group method must contain a _id tag");r=i.group(t,n);for(var o=Object.keys(e.$group),s=o.length,a=0;s>a;a++){var h=o[a];if("_id"!==h)for(var u=r.length,c=0;u>c;c++){var p=r[c];i.get(p,n[h].$first,h,!0),i.get(p,n[h].$last,h,!1),i.sum(p,n[h].$sum,h),i.avg(p,n[h].$avg,h),i.minMax(p,n[h].$max,h,!0),i.minMax(p,n[h].$min,h,!1)}}return r},l.prototype.group=function(t,e){for(var n=e._id,r=[],i=t.length,o=0;i>o;o++){var a=t[o][n],h=s(r,"_id",a);-1!==h?r[h]._group.push(t[o]):r.push({_id:a,_group:[t[o]]})}return r},l.prototype.get=function(t,e,n,r){if(e&&t._group.length>0){var i=r?0:t._group.length-1;t[n]=t._group[i][e]}},l.prototype.sum=function(t,e,n){e&&t._group.length>0&&(t[n]="number"==typeof e?t._group.length*e:t._group.reduce(function(t,n){return t+n[e]},0))},l.prototype.avg=function(t,e,n){if("string"!=typeof e)return void console.error("The $avg field must be a string");if(e&&t._group.length>0&&"number"==typeof t._group[0][e]){for(var r=t._group.length,i=0,o=0;r>o;o++)i+=t._group[o][e];t[n]=i/r}},l.prototype.minMax=function(t,e,n,r){if("string"!=typeof e)return void console.error("The $min & $max fields must be a string");if(e&&t._group.length>0&&"number"==typeof t._group[0][e]){for(var i=t._group.length,o=r?0:1/0,s=0;i>s;s++){var a=t._group[s][e];o=r?Math.max(o,a):Math.min(o,a)}t[n]=o}},l.prototype.sort=function(t,e){"function"==typeof e?t.sort(e):console.warn("LocalModel: $sort should be a compare function")},l.prototype.limit=function(t,e){return"number"==typeof e?t.slice(0,e):void console.warn("LocalModel: $limit should be a number")};var g=function(t){this.options=t||{},this.options.enabled=t.enabled||!1};g.prototype.log=function(){this.options.enabled&&console.log("[LocalModel]",arguments)};var d=function(t,e){this._schema=e,this._original={},this._indexKey=h(e.name,t._id),t._id&&(this._original._id=t._id,this._id=t._id);for(var n=e.keys.length,r=0;n>r;r++){var i=e.keys[r],o=t[i];o=d.convert(i,o,e.schema),o&&(this._original[i]=o,this[i]=o)}};d.convert=function(t,e,n){var r;return"object"==typeof n[t]?(r=n[t].type?n[t].type:v.SchemaTypes.String,n[t]["default"]&&!e&&(e=n[t]["default"])):r=n[t],e&&r===v.SchemaTypes.Date&&(e=new Date(e)),e},d.prototype.save=function(){for(var t={},e=this._schema.keys.length,n=0;e>n;n++){var r=this._schema.keys[n];t[r]=i(this[r])?this._original[r]:this[r]}t._id=this._id;var o=h(this._schema.name,this._id);this._schema.options.storage.setItem(o,JSON.stringify(t))},d.prototype.populate=function(t,n){for(var r=t.split(" "),i=0;i<r.length;i++){var s=r[i];if(this._schema.schema[s]){var a=this._schema.schema[s].ref;if(!a)return void console.error("The name "+s+" does not have a ref");var h=this._schema.core.model(a),u={_id:this[s]},c=this._schema.schema[s].foreignKey;c&&(u={},u[c]=this[s]),n&&n.match&&(u=e(n.match,u));var p=h.find(u);if(p.length>0){if(n){n.sort&&"function"==typeof n.sort&&p.sort(n.sort),n.limit&&"number"==typeof n.limit&&p.length>n.limit&&(p=p.splice(0,n.limit));var f;f=n.select?n.select.split(" "):h.keys,p=o(p,f)}this[s]=1===p.length?p[0]:p}}else console.warn("The property "+s+" doesn't exist in this schema")}return this},d.prototype.remove=function(){f(this._schema.name,this._indexKey,this._schema.options),localStorage.removeItem(this._indexKey),this._schema.indices=null};var m=function(t){"undefined"==typeof Storage&&console.warn("Storage is not supported in this browser"),this.options=t||{},this.models={},this.options.storage||(this.options.storage=localStorage),this.options.debug=new g({enabled:t&&t.debug?!0:!1})};m.prototype.addModel=function(t,e){var n=new v(t,e,this,this.options);return this.models[t]=n,n},m.prototype.model=function(t){return this.models[t]?this.models[t]:(console.error('The model with name "'+t+'" does not exist.'),null)};var v=function(t,e,n,r){this.schema=e,this.name=t,this.options=r,this.core=n,this.keys=Object.keys(e),this.keys.push("_id")};v.prototype.addToSchema=function(t){for(var e=Object.keys(t),n=e.length,r=0;n>r;r++)this.schema[e[r]]=t[e[r]];this.keys=Object.keys(this.schema),this.keys.push("_id")},v.prototype.create=function(t){var e={};e._id=a();for(var n=this.keys.length,r=0;n>r;r++){var i=this.keys[r];if("_id"!==i){var o=t[i];!o&&this.schema[i]["default"]&&(o=this.schema[i]["default"]),e[i]=o}}var s=h(this.name,e._id);return this.options.storage.setItem(s,JSON.stringify(e)),u(this.name,s,this.options),this.indices=null,new d(e,this)},v.prototype.all=function(){var t=this;this.indices=this.indices||c(this.name,this.options);var e=[];if(!this.indices)return e;for(var n=this.indices.length,r=0;n>r;r++){var i=this.indices[r];e.push(this.options.storage.getItem(i))}return e=JSON.parse("["+e.join(",")+"]"),e=e.map(function(e){return new d(e,t)})},v.prototype.findById=function(t){this.indices=this.indices||c(this.name,this.options);var e=p(this.indices,t);return e?new d(JSON.parse(this.options.storage.getItem(e)),this):null},v.prototype.checkEntry=function(t,e){for(var r=this.keys.length,i=[],o=0;r>o;o++){var s=this.keys[o],a=e[s];if("undefined"!=typeof a){var h=a instanceof RegExp,u="object"==typeof a&&n(a);(h||""!==a&&!u)&&t[s]&&i.push(x(d.convert(s,t[s],this.schema),a))}}return i},v.prototype.find=function(t,e){if(this.indices=this.indices||c(this.name,this.options),!t||n(t))return e?this.indices.length:this.all();var i=e?0:[];if(!this.indices)return i;for(var o=0;o<this.indices.length;o++){var s=this.options.storage.getItem(this.indices[o]),a=JSON.parse(s),h=this.checkEntry(a,t);h.length>0&&!r(h)&&(e?i++:i.push(new d(a,this)))}return this.options.debug.log(i.length+" results found"),i},v.prototype.remove=function(t){for(var e=this.find(t),n=0;n<e.length;n++)e[n].remove();return e.length},v.prototype.count=function(t){return this.find(t,!0)},v.prototype.update=function(t,e){var n=this.find(t),r=n.length;if(1>r)return 0;for(var i=0;r>i;i++){for(var o=n[i],s=this.keys.length,a=0;s>a;a++){var h=this.keys[a];"undefined"!=typeof e[h]&&(o[h]=e[h])}o.save()}return n.length},v.prototype.findAndPopulate=function(t,e,n){var r=this.find(t),i=r.length;if(1>i)return[];for(var o=[],s=0;i>s;s++)o.push(r[s].populate(e,n));return o},v.prototype.aggregate=function(t){for(var e=this,n=this.all(),r=t.length,i=new l,o=0;r>o;o++){var s=t[o];if(s.$match)n=i.match(n,s,e);else if(s.$group)n=i.createGroup(n,s);else if(s.$sort)i.sort(n,s.$sort);else{if(!s.$limit)return void console.error("LocalModel: Aggregate currently only supports $match, $group, $sort & $limit query types. Query types can not be empty.");n=i.limit(n,s.$limit)}}return n},v.SchemaTypes={String:"string",Number:"number",Boolean:"boolean",Mixed:"mixed",Date:"date"};var y=function(t,e,n){var i=[];if(e.$gte){var o=n?new Date(e.$gte):e.$gte;i.push(t>=o)}if(e.$gt){var s=n?new Date(e.$gt):e.$gt;i.push(t>s)}if(e.$lte){var a=n?new Date(e.$lte):e.$lte;i.push(a>=t)}if(e.$lt){var h=n?new Date(e.$lt):e.$lt;i.push(h>t)}return!r(i)},_=function(t,e){return"number"==typeof t?y(t,e):t instanceof Date?y(t,e,!0):void 0},x=function(t,e){return e instanceof RegExp?e.test(t):"string"==typeof e||"number"==typeof e?t===e:"object"==typeof e?_(t,e):void 0};t.LocalModel=m,t.LocalSchema=v,t.LocalDocument=d}(window);