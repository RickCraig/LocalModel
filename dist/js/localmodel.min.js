/*!
 * LocalModel
 * Developer: Rick Craig
 * https://github.com/RickCraig/localmodel
 */
"use strict";var isEmpty=function(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0},containsFalse=function(e){for(var t=0;t<e.length;t++)if(!e[t])return!0;return!1},generateUUID=function(){var e=Date.now(),t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var a=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?a:3&a|8).toString(16)});return t},getKey=function(e,t){return e+"::"+t},addIndex=function(e,t){var a=e+"-index",n=localStorage.getItem(a),i=n?JSON.parse(n):[];i.push(t),localStorage.setItem(a,JSON.stringify(i))},getIndices=function(e){var t=localStorage.getItem(e+"-index");return JSON.parse(t)},getIndex=function(e,t){for(var a=new RegExp("::"+t,"g"),n=0;n<e.length;n++){var i=e[n];if(a.test(i))return i}},LocalDocument=function(e,t){this.schema=t,this.data={},this.indexKey=getKey(t.name,e._id),e._id&&(this.data._id=e._id);for(var a in t.schema){var n,i=e[a];"object"==typeof t.schema[a]?(n=t.schema[a].type?t.schema[a].type:LocalSchema.SchemaTypes.String,t.schema[a]["default"]&&!i&&(i=t.schema[a]["default"])):n=t.schema[a],i&&n===LocalSchema.SchemaTypes.Date&&(i=new Date(i)),i&&(this.data[a]=i)}};LocalDocument.prototype.save=function(){var e={};for(var t in this.schema.schema)e[t]=this.data[t];console.log(e);var a=getKey(this.schema.name,this.data._id);localStorage.setItem(a,JSON.stringify(e))};var LocalModel=function(e){this.options=e||{},this.models={}};LocalModel.prototype.addModel=function(e,t){var a=new LocalSchema(e,t);return this.models[e]=a,a},LocalModel.prototype.model=function(e){return this.models[e]?this.models[e]:(console.error('The model with name "'+e+'" does not exist.'),null)};var LocalSchema=function(e,t){this.schema=t,this.name=e};LocalSchema.prototype.create=function(e){var t={};t._id=generateUUID();for(var a in this.schema){var n=e[a];!n&&this.schema[a]["default"]&&(n=this.schema[a]["default"]),t[a]=n}var i=getKey(this.name,t._id);return localStorage.setItem(i,JSON.stringify(t)),addIndex(this.name,i),this.indices=null,new LocalDocument(t,this)},LocalSchema.prototype.all=function(){this.indices=this.indices||getIndices(this.name);var e=[];if(!this.indices)return e;for(var t=0;t<this.indices.length;t++){var a=this.indices[t],n=JSON.parse(localStorage.getItem(a));e.push(new LocalDocument(n,this))}return e},LocalSchema.prototype.findById=function(e){this.indices=this.indices||getIndices(this.name);var t=getIndex(this.indices,e);return t?new LocalDocument(JSON.parse(localStorage.getItem(t)),this):null},LocalSchema.prototype.find=function(e){if(!e||isEmpty(e))return this.all();this.indices=this.indices||getIndices(this.name);var t=[];if(!this.indices)return t;for(var a=0;a<this.indices.length;a++){var n=localStorage.getItem(this.indices[a]),i=JSON.parse(n),r=[];for(var s in e){var o=e[s],c=o instanceof RegExp;(c||""!==o&&!isEmpty(o))&&i[s]&&r.push(matchQuery(i[s],o))}containsFalse(r)||t.push(new LocalDocument(i,this))}return t},LocalSchema.SchemaTypes={String:"string",Number:"number",Boolean:"boolean",Mixed:"mixed",Date:"date"};var matchQuery=function(e,t){if(t instanceof RegExp)return t.test(e);if("string"==typeof t||"number"==typeof t)return e===t;if("object"==typeof t&&"number"==typeof e){var a=[];return t.$gte&&a.push(t.$gte<=e),t.$gt&&a.push(t.$gt<e),t.$lte&&a.push(t.$lte>=e),t.$lt&&a.push(t.$lt>e),!containsFalse(a)}};