/*!
 * LocalModel
 * Developer: Rick Craig
 * https://github.com/RickCraig/localmodel
 */
"use strict";var isEmpty=function(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0},containsFalse=function(e){for(var t=0;t<e.length;t++)if(!e[t])return!0;return!1},generateUUID=function(){var e=Date.now(),t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var n=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?n:3&n|8).toString(16)});return t},getKey=function(e,t){return e+"::"+t},addIndex=function(e,t,n){var i=e+"-index",o=n.storage.getItem(i),s=o?JSON.parse(o):[];s.push(t),n.storage.setItem(i,JSON.stringify(s))},getIndices=function(e,t){var n=t.storage.getItem(e+"-index");return JSON.parse(n)},getIndex=function(e,t){for(var n=new RegExp("::"+t,"g"),i=0;i<e.length;i++){var o=e[i];if(n.test(o))return o}},removeIndex=function(e,t,n){var i=getIndices(e,n),o=i.indexOf(t);o>-1?(i.splice(o,1),n.storage.setItem(e+"-index",JSON.stringify(i))):console.error(new Error('The key "'+t+"\" doesn't exist"))},LocalDocument=function(e,t){this.schema=t,this.data={},this.indexKey=getKey(t.name,e._id),e._id&&(this.data._id=e._id);for(var n in t.schema){var i=e[n];i=LocalDocument.convert(n,i,t.schema),i&&(this.data[n]=i)}};LocalDocument.convert=function(e,t,n){var i;return"object"==typeof n[e]?(i=n[e].type?n[e].type:LocalSchema.SchemaTypes.String,n[e]["default"]&&!t&&(t=n[e]["default"])):i=n[e],t&&i===LocalSchema.SchemaTypes.Date&&(t=new Date(t)),t},LocalDocument.prototype.save=function(){var e={};for(var t in this.schema.schema)e[t]=this.data[t];e._id=this.data._id;var n=getKey(this.schema.name,this.data._id);this.schema.options.storage.setItem(n,JSON.stringify(e))},LocalDocument.prototype.remove=function(){removeIndex(this.schema.name,this.indexKey,this.schema.options),localStorage.removeItem(this.indexKey),this.schema.indices=null};var LocalModel=function(e){"undefined"==typeof Storage&&console.warn("Storage is not supported in this browser"),this.options=e||{},this.models={},this.options.storage||(this.options.storage=localStorage)};LocalModel.prototype.addModel=function(e,t){var n=new LocalSchema(e,t,this.options);return this.models[e]=n,n},LocalModel.prototype.model=function(e){return this.models[e]?this.models[e]:(console.error('The model with name "'+e+'" does not exist.'),null)};var LocalSchema=function(e,t,n){this.schema=t,this.name=e,this.options=n};LocalSchema.prototype.create=function(e){var t={};t._id=generateUUID();for(var n in this.schema){var i=e[n];!i&&this.schema[n]["default"]&&(i=this.schema[n]["default"]),t[n]=i}var o=getKey(this.name,t._id);return this.options.storage.setItem(o,JSON.stringify(t)),addIndex(this.name,o,this.options),this.indices=null,new LocalDocument(t,this)},LocalSchema.prototype.all=function(){this.indices=this.indices||getIndices(this.name,this.options);var e=[];if(!this.indices)return e;for(var t=0;t<this.indices.length;t++){var n=this.indices[t],i=JSON.parse(this.options.storage.getItem(n));e.push(new LocalDocument(i,this))}return e},LocalSchema.prototype.findById=function(e){this.indices=this.indices||getIndices(this.name,this.options);var t=getIndex(this.indices,e);return t?new LocalDocument(JSON.parse(this.options.storage.getItem(t)),this):null},LocalSchema.prototype.find=function(e,t){if(this.indices=this.indices||getIndices(this.name,this.options),!e||isEmpty(e))return t?this.indices.length:this.all();var n=t?0:[];if(!this.indices)return n;for(var i=0;i<this.indices.length;i++){var o=this.options.storage.getItem(this.indices[i]),s=JSON.parse(o),a=[];for(var r in e){var c=e[r],h=c instanceof RegExp,u="object"==typeof c&&isEmpty(c);(h||""!==c&&!u)&&a.push(s[r]?matchQuery(LocalDocument.convert(r,s[r],this.schema),c):!1)}containsFalse(a)||(t?n++:n.push(new LocalDocument(s,this)))}return n},LocalSchema.prototype.remove=function(e){for(var t=this.find(e),n=0;n<t.length;n++)t[n].remove();return t.length},LocalSchema.prototype.count=function(e){return this.find(e,!0)},LocalSchema.prototype.update=function(e,t){for(var n=this.find(e),i=0;i<n.length;i++){var o=n[i];for(var s in this.schema)"undefined"!=typeof t[s]&&(o.data[s]=t[s]);o.save()}return n.length},LocalSchema.SchemaTypes={String:"string",Number:"number",Boolean:"boolean",Mixed:"mixed",Date:"date"};var matchQuery=function(e,t){if(t instanceof RegExp)return t.test(e);if("string"==typeof t||"number"==typeof t)return e===t;if("object"==typeof t){if("number"==typeof e){var n=[];return t.$gte&&n.push(t.$gte<=e),t.$gt&&n.push(t.$gt<e),t.$lte&&n.push(t.$lte>=e),t.$lt&&n.push(t.$lt>e),!containsFalse(n)}if(e instanceof Date){var i=[];return t.$gte&&i.push(new Date(t.$gte)<=e),t.$gt&&i.push(new Date(t.$gt)<e),t.$lte&&i.push(new Date(t.$lte)>=e),t.$lt&&i.push(new Date(t.$lt)>e),!containsFalse(i)}}};