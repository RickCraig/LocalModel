/*!
 * LocalModel
 * Developer: Rick Craig
 * https://github.com/RickCraig/localmodel
 */
"use strict";var isEmpty=function(t){for(var e in t)if(t.hasOwnProperty(e))return!1;return!0},containsFalse=function(t){for(var e=0;e<t.length;e++)if(!t[e])return!0;return!1},generateUUID=function(){var t=Date.now(),e="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var n=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"===e?n:3&n|8).toString(16)});return e},getKey=function(t,e){return t+"::"+e},addIndex=function(t,e,n){var i=t+"-index",s=n.storage.getItem(i),o=s?JSON.parse(s):[];o.push(e),n.storage.setItem(i,JSON.stringify(o))},getIndices=function(t,e){var n=e.storage.getItem(t+"-index");return JSON.parse(n)},getIndex=function(t,e){for(var n=new RegExp("::"+e,"g"),i=0;i<t.length;i++){var s=t[i];if(n.test(s))return s}},removeIndex=function(t,e,n){var i=getIndices(t,n),s=i.indexOf(e);s>-1?(i.splice(s,1),n.storage.setItem(t+"-index",JSON.stringify(i))):console.error(new Error('The key "'+e+"\" doesn't exist"))},LocalDebug=function(t){this.options=t||{},this.options.enabled=t.enabled||!1};LocalDebug.prototype.start=function(t){this.options.enabled&&console.time(t)},LocalDebug.prototype.end=function(t){this.options.enabled&&console.timeEnd(t)},LocalDebug.prototype.log=function(){this.options.enabled&&console.log("[LocalModel]",arguments)};var LocalDocument=function(t,e){this.schema=e,this.schema.options.debug.start("Instantiating entry"),this.data={},this.indexKey=getKey(e.name,t._id),t._id&&(this.data._id=t._id);for(var n=e.keys.length,i=0;n>i;i++){var s=e.keys[i],o=t[s];o=LocalDocument.convert(s,o,e.schema),o&&(this.data[s]=o)}this.schema.options.debug.end("Instantiating entry")};LocalDocument.convert=function(t,e,n){var i;return"object"==typeof n[t]?(i=n[t].type?n[t].type:LocalSchema.SchemaTypes.String,n[t]["default"]&&!e&&(e=n[t]["default"])):i=n[t],e&&i===LocalSchema.SchemaTypes.Date&&(e=new Date(e)),e},LocalDocument.prototype.save=function(){this.schema.options.debug.start("Saving entry");for(var t={},e=this.schema.keys.length,n=0;e>n;n++){var i=this.schema.keys[n];t[i]=this.data[i]}t._id=this.data._id;var s=getKey(this.schema.name,this.data._id);this.schema.options.storage.setItem(s,JSON.stringify(t)),this.schema.options.debug.end("Saving entry")},LocalDocument.prototype.remove=function(){this.schema.options.debug.start("Removing entry"),removeIndex(this.schema.name,this.indexKey,this.schema.options),localStorage.removeItem(this.indexKey),this.schema.indices=null,this.schema.options.debug.end("Removing entry")};var LocalModel=function(t){"undefined"==typeof Storage&&console.warn("Storage is not supported in this browser"),this.options=t||{},this.models={},this.options.storage||(this.options.storage=localStorage),this.options.debug=new LocalDebug({enabled:t&&t.debug?!0:!1})};LocalModel.prototype.addModel=function(t,e){var n=new LocalSchema(t,e,this.options);return this.models[t]=n,n},LocalModel.prototype.model=function(t){return this.models[t]?this.models[t]:(console.error('The model with name "'+t+'" does not exist.'),null)};var LocalSchema=function(t,e,n){this.schema=e,this.name=t,this.options=n,this.keys=Object.keys(e)};LocalSchema.prototype.addToSchema=function(t){for(var e=Object.keys(t),n=e.length,i=0;n>i;i++)this.schema[e[i]]=t[e[i]];this.keys=Object.keys(this.schema)},LocalSchema.prototype.create=function(t){this.options.debug.start("Creating "+this.name);var e={};e._id=generateUUID();for(var n=this.keys.length,i=0;n>i;i++){var s=this.keys[i],o=t[s];!o&&this.schema[s]["default"]&&(o=this.schema[s]["default"]),e[s]=o}var a=getKey(this.name,e._id);return this.options.storage.setItem(a,JSON.stringify(e)),addIndex(this.name,a,this.options),this.indices=null,this.options.debug.end("Creating "+this.name),new LocalDocument(e,this)},LocalSchema.prototype.all=function(){this.options.debug.start("Getting all "+this.name+"s");var t=this;this.indices=this.indices||getIndices(this.name,this.options);var e=[];if(!this.indices)return e;for(var n=this.indices.length,i=0;n>i;i++){var s=this.indices[i];e.push(this.options.storage.getItem(s))}return e=JSON.parse("["+e.join(",")+"]"),e=e.map(function(e){return new LocalDocument(e,t)}),this.options.debug.end("Getting all "+this.name+"s"),e},LocalSchema.prototype.findById=function(t){this.indices=this.indices||getIndices(this.name,this.options);var e=getIndex(this.indices,t);return e?new LocalDocument(JSON.parse(this.options.storage.getItem(e)),this):null},LocalSchema.prototype.find=function(t,e){if(this.options.debug.start("Finding "+this.name+"s"),this.indices=this.indices||getIndices(this.name,this.options),!t||isEmpty(t))return e?this.indices.length:this.all();var n=e?0:[];if(!this.indices)return n;for(var i=0;i<this.indices.length;i++){for(var s=this.options.storage.getItem(this.indices[i]),o=JSON.parse(s),a=[],r=this.keys.length,h=0;r>h;h++){var c=this.keys[h],d=t[c];if("undefined"!=typeof d){var u=d instanceof RegExp,l="object"==typeof d&&isEmpty(d);(u||""!==d&&!l)&&o[c]&&a.push(matchQuery(LocalDocument.convert(c,o[c],this.schema),d))}}a.length>0&&!containsFalse(a)&&(e?n++:n.push(new LocalDocument(o,this)))}return this.options.debug.end("Finding "+this.name+"s"),this.options.debug.log(n.length+" results found"),n},LocalSchema.prototype.remove=function(t){for(var e=this.find(t),n=0;n<e.length;n++)e[n].remove();return e.length},LocalSchema.prototype.count=function(t){return this.find(t,!0)},LocalSchema.prototype.update=function(t,e){this.options.debug.start("Updating "+this.name+"s");for(var n=this.find(t),i=n.length,s=0;i>s;s++){for(var o=n[s],a=this.keys.length,r=0;a>r;r++){var h=this.keys[r];"undefined"!=typeof e[h]&&(o.data[h]=e[h])}o.save()}return this.options.debug.end("Updating "+this.name+"s"),n.length},LocalSchema.SchemaTypes={String:"string",Number:"number",Boolean:"boolean",Mixed:"mixed",Date:"date"};var matchQuery=function(t,e){if(e instanceof RegExp)return e.test(t);if("string"==typeof e||"number"==typeof e)return t===e;if("object"==typeof e){if("number"==typeof t){var n=[];return e.$gte&&n.push(e.$gte<=t),e.$gt&&n.push(e.$gt<t),e.$lte&&n.push(e.$lte>=t),e.$lt&&n.push(e.$lt>t),!containsFalse(n)}if(t instanceof Date){var i=[];return e.$gte&&i.push(new Date(e.$gte)<=t),e.$gt&&i.push(new Date(e.$gt)<t),e.$lte&&i.push(new Date(e.$lte)>=t),e.$lt&&i.push(new Date(e.$lt)>t),!containsFalse(i)}}};