/*!
 * LocalModel
 * Developer: Rick Craig
 * https://github.com/RickCraig/localmodel
 */
"use strict";var isEmpty=function(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0},containsFalse=function(e){for(var t=0;t<e.length;t++)if(!e[t])return!0;return!1},generateUUID=function(){var e=Date.now(),t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var n=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?n:3&n|8).toString(16)});return t},getKey=function(e,t){return e+"::"+t},addIndex=function(e,t){var n=e+"-index",a=localStorage.getItem(n),i=a?JSON.parse(a):[];i.push(t),localStorage.setItem(n,JSON.stringify(i))},getIndices=function(e){var t=localStorage.getItem(e+"-index");return JSON.parse(t)},getIndex=function(e,t){for(var n=new RegExp("::"+t,"g"),a=0;a<e.length;a++){var i=e[a];if(n.test(i))return i}},removeIndex=function(e,t){var n=getIndices(e),a=n.indexOf(t);a>-1?(n.splice(a,1),localStorage.setItem(e+"-index",JSON.stringify(n))):console.error(new Error('The key "'+t+"\" doesn't exist"))},LocalDocument=function(e,t){this.schema=t,this.data={},this.indexKey=getKey(t.name,e._id),e._id&&(this.data._id=e._id);for(var n in t.schema){var a=e[n];a=LocalDocument.convert(n,a,t.schema),a&&(this.data[n]=a)}};LocalDocument.convert=function(e,t,n){var a;return"object"==typeof n[e]?(a=n[e].type?n[e].type:LocalSchema.SchemaTypes.String,n[e]["default"]&&!t&&(t=n[e]["default"])):a=n[e],t&&a===LocalSchema.SchemaTypes.Date&&(t=new Date(t)),t},LocalDocument.prototype.save=function(){var e={};for(var t in this.schema.schema)e[t]=this.data[t];var n=getKey(this.schema.name,this.data._id);localStorage.setItem(n,JSON.stringify(e))},LocalDocument.prototype.remove=function(){removeIndex(this.schema.name,this.indexKey),localStorage.removeItem(this.indexKey),this.schema.indices=null};var LocalModel=function(e){"undefined"==typeof Storage&&console.error(new Error("Storage is not supported in this browser")),this.options=e||{},this.models={}};LocalModel.prototype.addModel=function(e,t){var n=new LocalSchema(e,t);return this.models[e]=n,n},LocalModel.prototype.model=function(e){return this.models[e]?this.models[e]:(console.error('The model with name "'+e+'" does not exist.'),null)};var LocalSchema=function(e,t){this.schema=t,this.name=e};LocalSchema.prototype.create=function(e){var t={};t._id=generateUUID();for(var n in this.schema){var a=e[n];!a&&this.schema[n]["default"]&&(a=this.schema[n]["default"]),t[n]=a}var i=getKey(this.name,t._id);return localStorage.setItem(i,JSON.stringify(t)),addIndex(this.name,i),this.indices=null,new LocalDocument(t,this)},LocalSchema.prototype.all=function(){this.indices=this.indices||getIndices(this.name);var e=[];if(!this.indices)return e;for(var t=0;t<this.indices.length;t++){var n=this.indices[t],a=JSON.parse(localStorage.getItem(n));e.push(new LocalDocument(a,this))}return e},LocalSchema.prototype.findById=function(e){this.indices=this.indices||getIndices(this.name);var t=getIndex(this.indices,e);return t?new LocalDocument(JSON.parse(localStorage.getItem(t)),this):null},LocalSchema.prototype.find=function(e){if(!e||isEmpty(e))return this.all();this.indices=this.indices||getIndices(this.name);var t=[];if(!this.indices)return t;for(var n=0;n<this.indices.length;n++){var a=localStorage.getItem(this.indices[n]),i=JSON.parse(a),o=[];for(var r in e){var s=e[r],c=s instanceof RegExp;(c||""!==s&&!isEmpty(s))&&o.push(i[r]?matchQuery(LocalDocument.convert(r,i[r],this.schema),s):!1)}containsFalse(o)||t.push(new LocalDocument(i,this))}return t},LocalSchema.prototype.remove=function(e){for(var t=this.find(e),n=0;n<t.length;n++)t[n].remove()},LocalSchema.SchemaTypes={String:"string",Number:"number",Boolean:"boolean",Mixed:"mixed",Date:"date"};var matchQuery=function(e,t){if(t instanceof RegExp)return t.test(e);if("string"==typeof t||"number"==typeof t)return e===t;if("object"==typeof t){if("number"==typeof e){var n=[];return t.$gte&&n.push(t.$gte<=e),t.$gt&&n.push(t.$gt<e),t.$lte&&n.push(t.$lte>=e),t.$lt&&n.push(t.$lt>e),!containsFalse(n)}if(e instanceof Date){var a=[];return t.$gte&&a.push(new Date(t.$gte)<=e),t.$gt&&a.push(new Date(t.$gt)<e),t.$lte&&a.push(new Date(t.$lte)>=e),t.$lt&&a.push(new Date(t.$lt)>e),!containsFalse(a)}}};