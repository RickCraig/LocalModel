/*!
 * LocalModel
 * Developer: Rick Craig
 * https://github.com/RickCraig/localmodel
*/
!function(t){"use strict";function e(t,e){for(var i={},n=Object.keys(t),s=Object.keys(e),r=0;r<n.length;r++)i[n[r]]=t[n[r]];for(var o=0;o<s.length;o++)i[s[o]]=e[s[o]];return i}var i=function(t){for(var e in t)if(t.hasOwnProperty(e))return!1;return!0},n=function(t){for(var e=0;e<t.length;e++)if(!t[e])return!0;return!1},s=function(t){return t instanceof Object||t instanceof Array?!0:!1},r=function(t,e){return t.map(function(t){for(var i={},n=0;n<e.length;n++)i[e[n]]=t[e[n]];return i})},o=function(){var t=Date.now(),e="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var i=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"===e?i:3&i|8).toString(16)});return e},a=function(t,e){return t+"::"+e},h=function(t,e,i){var n=t+"-index",s=i.storage.getItem(n),r=s?JSON.parse(s):[];r.push(e),i.storage.setItem(n,JSON.stringify(r))},c=function(t,e){var i=e.storage.getItem(t+"-index");return JSON.parse(i)},f=function(t,e){for(var i=new RegExp("::"+e,"g"),n=0;n<t.length;n++){var s=t[n];if(i.test(s))return s}},u=function(t,e,i){var n=c(t,i),s=n.indexOf(e);s>-1?(n.splice(s,1),i.storage.setItem(t+"-index",JSON.stringify(n))):console.error(new Error('The key "'+e+"\" doesn't exist"))},p=function(t){this.options=t||{},this.options.enabled=t.enabled||!1};p.prototype.log=function(){this.options.enabled&&console.log("[LocalModel]",arguments)};var l=function(t,e){this._schema=e,this._original={},this._indexKey=a(e.name,t._id),t._id&&(this._original._id=t._id,this._id=t._id);for(var i=e.keys.length,n=0;i>n;n++){var s=e.keys[n],r=t[s];r=l.convert(s,r,e.schema),r&&(this._original[s]=r,this[s]=r)}};l.convert=function(t,e,i){var n;return"object"==typeof i[t]?(n=i[t].type?i[t].type:g.SchemaTypes.String,i[t]["default"]&&!e&&(e=i[t]["default"])):n=i[t],e&&n===g.SchemaTypes.Date&&(e=new Date(e)),e},l.prototype.save=function(){for(var t={},e=this._schema.keys.length,i=0;e>i;i++){var n=this._schema.keys[i];t[n]=s(this[n])?this._original[n]:this[n]}t._id=this._id;var r=a(this._schema.name,this._id);this._schema.options.storage.setItem(r,JSON.stringify(t))},l.prototype.populate=function(t,i){for(var n=t.split(" "),s=0;s<n.length;s++){var o=n[s];if(this._schema.schema[o]){var a=this._schema.schema[o].ref;if(!a)return void console.error("The name "+o+" does not have a ref");var h=this._schema.core.model(a),c={_id:this[o]},f=this._schema.schema[o].foreignKey;f&&(c={},c[f]=this[o]),i&&i.match&&(c=e(i.match,c));var u=h.find(c);if(u.length>0){if(i){i.sort&&"function"==typeof i.sort&&u.sort(i.sort),i.limit&&"number"==typeof i.limit&&u.length>i.limit&&(u=u.splice(0,i.limit));var p;p=i.select?i.select.split(" "):h.keys,u=r(u,p)}this[o]=1===u.length?u[0]:u}}else console.warn("The property "+o+" doesn't exist in this schema")}return this},l.prototype.remove=function(){u(this._schema.name,this._indexKey,this._schema.options),localStorage.removeItem(this._indexKey),this._schema.indices=null};var d=function(t){"undefined"==typeof Storage&&console.warn("Storage is not supported in this browser"),this.options=t||{},this.models={},this.options.storage||(this.options.storage=localStorage),this.options.debug=new p({enabled:t&&t.debug?!0:!1})};d.prototype.addModel=function(t,e){var i=new g(t,e,this,this.options);return this.models[t]=i,i},d.prototype.model=function(t){return this.models[t]?this.models[t]:(console.error('The model with name "'+t+'" does not exist.'),null)};var g=function(t,e,i,n){this.schema=e,this.name=t,this.options=n,this.core=i,this.keys=Object.keys(e),this.keys.push("_id")};g.prototype.addToSchema=function(t){for(var e=Object.keys(t),i=e.length,n=0;i>n;n++)this.schema[e[n]]=t[e[n]];this.keys=Object.keys(this.schema),this.keys.push("_id")},g.prototype.create=function(t){var e={};e._id=o();for(var i=this.keys.length,n=0;i>n;n++){var s=this.keys[n];if("_id"!==s){var r=t[s];!r&&this.schema[s]["default"]&&(r=this.schema[s]["default"]),e[s]=r}}var c=a(this.name,e._id);return this.options.storage.setItem(c,JSON.stringify(e)),h(this.name,c,this.options),this.indices=null,new l(e,this)},g.prototype.all=function(){var t=this;this.indices=this.indices||c(this.name,this.options);var e=[];if(!this.indices)return e;for(var i=this.indices.length,n=0;i>n;n++){var s=this.indices[n];e.push(this.options.storage.getItem(s))}return e=JSON.parse("["+e.join(",")+"]"),e=e.map(function(e){return new l(e,t)})},g.prototype.findById=function(t){this.indices=this.indices||c(this.name,this.options);var e=f(this.indices,t);return e?new l(JSON.parse(this.options.storage.getItem(e)),this):null},g.prototype.checkEntry=function(t,e){for(var n=this.keys.length,s=[],r=0;n>r;r++){var o=this.keys[r],a=e[o];if("undefined"!=typeof a){var h=a instanceof RegExp,c="object"==typeof a&&i(a);(h||""!==a&&!c)&&t[o]&&s.push(y(l.convert(o,t[o],this.schema),a))}}return s},g.prototype.find=function(t,e){if(this.indices=this.indices||c(this.name,this.options),!t||i(t))return e?this.indices.length:this.all();var s=e?0:[];if(!this.indices)return s;for(var r=0;r<this.indices.length;r++){var o=this.options.storage.getItem(this.indices[r]),a=JSON.parse(o),h=this.checkEntry(a,t);h.length>0&&!n(h)&&(e?s++:s.push(new l(a,this)))}return this.options.debug.log(s.length+" results found"),s},g.prototype.remove=function(t){for(var e=this.find(t),i=0;i<e.length;i++)e[i].remove();return e.length},g.prototype.count=function(t){return this.find(t,!0)},g.prototype.update=function(t,e){var i=this.find(t),n=i.length;if(1>n)return 0;for(var s=0;n>s;s++){for(var r=i[s],o=this.keys.length,a=0;o>a;a++){var h=this.keys[a];"undefined"!=typeof e[h]&&(r[h]=e[h])}r.save()}return i.length},g.prototype.findAndPopulate=function(t,e,i){var n=this.find(t),s=n.length;if(1>s)return[];for(var r=[],o=0;s>o;o++)r.push(n[o].populate(e,i));return r},g.SchemaTypes={String:"string",Number:"number",Boolean:"boolean",Mixed:"mixed",Date:"date"};var m=function(t,e,i){var s=[];if(e.$gte){var r=i?new Date(e.$gte):e.$gte;s.push(t>=r)}if(e.$gt){var o=i?new Date(e.$gt):e.$gt;s.push(t>o)}if(e.$lte){var a=i?new Date(e.$lte):e.$lte;s.push(a>=t)}if(e.$lt){var h=i?new Date(e.$lt):e.$lt;s.push(h>t)}return!n(s)},v=function(t,e){return"number"==typeof t?m(t,e):t instanceof Date?m(t,e,!0):void 0},y=function(t,e){return e instanceof RegExp?e.test(t):"string"==typeof e||"number"==typeof e?t===e:"object"==typeof e?v(t,e):void 0};t.LocalModel=d,t.LocalSchema=g,t.LocalDocument=l}(window);